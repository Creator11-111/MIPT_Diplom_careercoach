# Методы и алгоритмы системы

**Дата:** 2025-01-12  
**Версия:** 1.0.0

---

## 1. Обзор методов

Система использует комбинацию методов машинного обучения и обработки естественного языка для решения задач карьерного коучинга в финансовом секторе.

---

## 2. Семантический поиск вакансий

### 2.1 Архитектура поиска

Реализован многоэтапный алгоритм поиска:

```
Резюме → Препроцессинг → Эмбеддинг → FAISS (топ-100) → LLM Stage 1 (топ-30) → LLM Stage 2 (топ-15)
```

### 2.2 Генерация эмбеддингов

**Модель:** YandexGPT Embeddings API  
**Размерность:** 256  
**Файл:** `app/services/yandex_sdk.py`, функция `embed_text()`

Для каждой вакансии создаётся текстовое представление:
```python
# data_parsing/generate_embeddings.py
def create_text_for_embedding(vacancy):
    parts = []
    if title := vacancy.get("title"):
        parts.append(f"Должность: {title}")
    if description := vacancy.get("description"):
        parts.append(f"Описание: {description[:1000]}")
    if skills := vacancy.get("key_skills"):
        parts.append(f"Навыки: {skills}")
    return "\n".join(parts)
```

### 2.3 FAISS индекс

**Тип индекса:** HNSW (Hierarchical Navigable Small World)  
**Параметры:**
- `M = 32` (количество соседей в графе)
- `efConstruction = 200` (точность построения)

**Файл:** `app/startup/load_embeddings.py`

```python
def build_faiss():
    # Нормализация векторов для косинусного сходства
    norms = np.linalg.norm(X, axis=1, keepdims=True) + 1e-12
    X_normalized = X / norms
    
    # Создание HNSW индекса
    index = faiss.IndexHNSWFlat(dim, 32)
    index.hnsw.efConstruction = 200
    index.add(X_normalized.astype('float32'))
```

### 2.4 Двухэтапная LLM-фильтрация

**Stage 1:** Фильтрация по названиям вакансий  
- Вход: 100 вакансий (idx: title)
- Выход: 30 наиболее релевантных
- Промпт: `MATCH_SYSTEM_PROMPT_STAGE1`

**Stage 2:** Фильтрация по полным описаниям  
- Вход: 30 вакансий с описаниями
- Выход: 15 финальных вакансий
- Промпт: `MATCH_SYSTEM_PROMPT_STAGE2`

---

## 3. Извлечение профиля из диалога

### 3.1 Структурированное извлечение

**Метод:** Structured Completion с JSON-схемой  
**Файл:** `app/services/profile_service.py`

Промпт требует максимальной детализации:
- Все места работы с задачами и достижениями
- Все навыки (hard/soft)
- Все сертификаты и курсы
- Цели и предпочтения

### 3.2 Схема профиля

```python
class UserProfile(BaseModel):
    professional_context: ProfessionalContext  # роль, сфера, уровень
    resume: List[ResumeItem]                   # опыт работы
    skills: Skills                             # навыки, инструменты
    goals: Goals                               # карьерные цели
    achievements: List[str]                    # достижения
    preferences: Preferences                   # формат работы, локация
```

---

## 4. Генерация плана развития

### 4.1 Gap Analysis

Анализ разрыва между текущим профилем и целевой позицией:
1. Сравнение навыков
2. Определение недостающих компетенций
3. Приоритизация по важности

**Промпт:** `GAP_ANALYSIS_SYSTEM_PROMPT`

### 4.2 Подбор курсов

Генерация рекомендаций через LLM на основе:
- Выявленных разрывов
- Специфики финансового сектора
- Уровня кандидата

### 4.3 Поиск вакансий роста

1. Генерация "будущего резюме" через LLM
2. Поиск промежуточных вакансий через MatchService
3. Формирование карьерной траектории

---

## 5. Диалоговая система

### 5.1 Управление контекстом

**Файл:** `app/services/chat_service.py`

- История ограничена 40 последними сообщениями
- Динамический выбор промпта по типу чата
- Флаг `done` для определения завершённости интервью

### 5.2 Типы чатов

1. **Интервью** — сбор информации (8-10 вопросов)
2. **Развитие карьеры** — планирование роста
3. **Анализ навыков** — оценка компетенций
4. **Анализ целей** — SWOT и реалистичность

---

## 6. Метрики качества

### 6.1 Поиск вакансий

- **Precision@15**: доля релевантных в топ-15
- **Recall@100**: полнота на этапе FAISS
- **NDCG**: качество ранжирования

### 6.2 Профиль

- **Completeness**: заполненность полей профиля
- **Accuracy**: соответствие извлечённых данных диалогу

### 6.3 Производительность

- **FAISS search**: < 0.3 сек (p95)
- **LLM filtering**: < 4 сек (Stage 1 + Stage 2)
- **Total API response**: < 5 сек

---

## 7. Ограничения методов

1. **Зависимость от качества эмбеддингов** — точность поиска определяется моделью YandexGPT
2. **Галлюцинации LLM** — возможны неточности в генерации курсов
3. **Статический индекс** — вакансии не обновляются в реальном времени
4. **Offline dataset** — используется снимок данных, не API HH.ru

---

**Document Status:** ✅ Complete
