<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AI-–∫–æ—É—á –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º —Å–µ–∫—Ç–æ—Ä–µ">
    <meta name="theme-color" content="#10a37f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–∞—Ä—å–µ—Ä–Ω—ã–π –ö–æ—É—á</title>
    <style>
        :root {
            --primary: #10a37f;
            --primary-light: #1ec99b;
            --primary-dark: #0d8a6a;
            --bg: #1a1a2e;
            --sidebar-bg: #16162a;
            --ai-bg: #252542;
            --text: #f0f0f5;
            --text-dim: #9898b0;
            --border: #3d3d5c;
            --input-bg: #2a2a45;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --gold: #fbbf24;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #0f0f1a 50%, #1a0f2e 100%);
            background-attachment: fixed;
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(16, 163, 127, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(22, 22, 42, 0.95) 100%);
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: transform 0.3s ease;
            z-index: 100;
            border-right: 1px solid var(--border);
            backdrop-filter: blur(10px);
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .new-chat { 
            padding: 14px 18px; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px; 
            width: 100%;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        .new-chat:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 163, 127, 0.4);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 8px;
        }

        .history-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 13px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .history-item:hover { 
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }
        .history-item.active { 
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(16, 163, 127, 0.2) 100%);
            border-color: var(--primary);
            color: var(--text);
            font-weight: 500;
        }
        .history-item-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-delete {
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            color: var(--danger);
            font-size: 18px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .history-item:hover .history-item-delete {
            opacity: 1;
        }
        .history-item-delete:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .main { flex: 1; display: flex; flex-direction: column; position: relative; }

        .mobile-header { 
            display: none; 
            padding: 12px 20px; 
            border-bottom: 1px solid var(--border); 
            height: 56px; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            background: var(--sidebar-bg);
        }
        .menu-btn { 
            background: none; 
            border: none; 
            color: var(--text); 
            font-size: 24px; 
            position: absolute; 
            left: 16px; 
            cursor: pointer;
        }
        .mobile-header-title {
            font-weight: 600;
            font-size: 16px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chat { flex: 1; overflow-y: auto; padding-bottom: 140px; scroll-behavior: smooth; }

        /* Welcome Screen */
        .welcome { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            text-align: center; 
            padding: 30px;
        }
        .welcome h1 { 
            font-size: 42px; 
            margin-bottom: 16px; 
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 50%, var(--gold) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }
        .welcome-subtitle {
            font-size: 18px;
            color: var(--text-dim);
            margin-bottom: 48px;
            font-weight: 400;
            line-height: 1.6;
        }

        .grid { 
            display: flex; 
            justify-content: center;
            align-items: center;
            gap: 16px; 
            max-width: 600px;
            width: 100%;
        }
        .welcome-features {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
            color: var(--text-dim);
            font-size: 15px;
        }
        .feature-item {
            padding: 8px 0;
        }
        .card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
            padding: 24px; 
            border-radius: 18px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        .card-main {
            min-width: 320px;
            max-width: 400px;
            width: 100%;
            padding: 32px;
            font-size: 18px;
            text-align: center;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .card:hover::before {
            transform: scaleX(1);
        }
        .card:hover { 
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.2) 0%, rgba(16, 163, 127, 0.15) 100%);
            border-color: var(--primary);
            transform: translateY(-6px);
            box-shadow: 0 16px 40px rgba(16, 163, 127, 0.3);
        }
        .card:active { transform: translateY(-3px); }
        .card-icon {
            font-size: 32px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .card-sub { 
            font-size: 13px; 
            color: var(--text-dim); 
            margin-top: 10px;
            font-weight: 400;
            line-height: 1.5;
        }

        /* Messages */
        .msg { 
            padding: 24px 30px; 
            display: flex; 
            gap: 16px; 
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg.ai { 
            background: linear-gradient(135deg, rgba(37, 37, 66, 0.6) 0%, rgba(25, 25, 42, 0.8) 100%);
            backdrop-filter: blur(10px);
        }
        .msg-content { 
            max-width: 800px; 
            width: 100%; 
            line-height: 1.7; 
            font-size: 15px;
        }
        .msg-content a {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px dashed var(--primary);
            transition: all 0.2s;
        }
        .msg-content a:hover {
            color: var(--gold);
            border-color: var(--gold);
        }

        .avatar { 
            width: 36px; 
            height: 36px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
            font-size: 18px;
        }
        .avatar.user { background: linear-gradient(135deg, var(--accent) 0%, #4f46e5 100%); }
        .avatar.ai { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }

        /* Input Area */
        .input-area { 
            position: sticky; 
            bottom: 0; 
            width: 100%; 
            background: linear-gradient(180deg, transparent 0%, var(--bg) 30%);
            padding: 20px 30px 25px; 
            display: flex; 
            justify-content: center; 
            z-index: 50;
        }
        .input-wrap { 
            max-width: 800px; 
            width: 100%; 
            background: linear-gradient(145deg, rgba(42, 42, 69, 0.8) 0%, rgba(30, 30, 50, 0.9) 100%);
            border-radius: 18px; 
            border: 1px solid var(--border);
            display: flex; 
            align-items: flex-end; 
            padding: 14px 18px; 
            position: relative; 
            gap: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        .input-wrap:focus-within {
            border-color: var(--primary);
            box-shadow: 0 12px 40px rgba(16, 163, 127, 0.3);
            transform: translateY(-2px);
        }

        textarea { 
            width: 100%; 
            background: none; 
            border: none; 
            color: var(--text); 
            font-size: 15px; 
            resize: none; 
            max-height: 200px; 
            outline: none; 
            font-family: inherit;
            min-height: 24px;
            line-height: 1.5;
        }
        .send { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none; 
            cursor: pointer; 
            color: white;
            padding: 10px 14px; 
            font-size: 16px;
            border-radius: 10px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .send:hover { 
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.4);
        }
        .send:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }

        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; backdrop-filter: blur(4px); }
        .overlay.on { display: block; }

        /* Typing Animation */
        .typing-dots { display: flex; gap: 6px; padding: 8px 0; }
        .dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Buttons */
        .btn { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
            border: none; 
            padding: 14px 24px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            min-width: 140px;
            flex: 1;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 163, 127, 0.4);
        }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Vacancy & Course Cards */
        .vacancy-card, .course-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .vacancy-card:hover, .course-card:hover {
            border-color: var(--primary);
            transform: translateX(6px);
            box-shadow: 0 8px 24px rgba(16, 163, 127, 0.2);
        }
        .vacancy-level-badge {
            display: inline-block;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .vacancy-description {
            border-left: 3px solid var(--primary);
            padding-left: 12px;
        }
        .vacancy-title, .course-title { 
            font-size: 17px; 
            font-weight: 600; 
            color: var(--primary-light); 
            margin-bottom: 8px;
        }
        .vacancy-info, .course-info { 
            font-size: 13px; 
            color: var(--text-dim); 
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .vacancy-link, .course-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white !important;
            border-radius: 8px;
            text-decoration: none !important;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(16, 163, 127, 0.3);
        }
        .vacancy-link:hover, .course-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 163, 127, 0.5);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        }
        .vacancy-link:active, .course-link:active {
            transform: translateY(0);
        }

        /* Profile Card */
        .profile-card {
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.15) 0%, rgba(16, 163, 127, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .profile-section {
            margin-bottom: 20px;
        }
        .profile-section:last-child {
            margin-bottom: 0;
        }
        .profile-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .profile-item {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 6px;
            padding-left: 12px;
            border-left: 2px solid var(--primary);
        }
        .profile-tag {
            display: inline-block;
            background: rgba(16, 163, 127, 0.2);
            color: var(--primary-light);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin: 3px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--ai-bg);
            color: var(--text);
            padding: 16px 28px;
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            z-index: 1000;
            max-width: 90%;
            min-width: 300px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        .toast.warning { border-color: var(--gold); }

        /* Progress indicator */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
            background-size: 200% 100%;
            animation: progressMove 1.5s ease infinite;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: 9999;
            width: 100%;
        }
        .progress-bar.active {
            transform: scaleX(1);
        }
        @keyframes progressMove {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Mobile & Touch Optimization */
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; 
                height: 100%; 
                width: 300px; 
                transform: translateX(-100%); 
                box-shadow: 4px 0 20px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .msg { padding: 18px 16px; gap: 12px; }
            .msg-content { font-size: 16px; }
            .avatar { width: 32px; height: 32px; font-size: 16px; }
            .welcome h1 { font-size: 26px; }
            .welcome-subtitle { font-size: 14px; }
            .grid { grid-template-columns: 1fr; gap: 14px; max-width: 100%; }
            .card { padding: 18px; font-size: 15px; }
            .input-area { 
                position: fixed; 
                left: 0; 
                right: 0; 
                bottom: 0; 
                padding: 14px 16px 20px;
            }
            .input-wrap { padding: 10px 14px; }
            textarea { font-size: 16px; }
            .send { padding: 10px 14px; }
            .btn { min-width: 100%; padding: 14px 20px; font-size: 15px; margin: 6px 0; }
            .action-buttons { flex-direction: column; gap: 0; }
            .chat { padding-bottom: 120px; }
            .toast { bottom: 130px; }
            footer {
                bottom: 12px;
                left: 12px;
                font-size: 12px;
            }
            
            @supports (padding-bottom: env(safe-area-inset-bottom)) {
                .input-area { padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
            }
        }
        
        @media (min-width: 1400px) {
            .msg-content { max-width: 900px; }
            .input-wrap { max-width: 900px; }
            .grid { max-width: 800px; }
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>
    <div class="toast" id="toast"></div>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <button class="new-chat" onclick="newChat()">+ –ù–æ–≤—ã–π —á–∞—Ç</button>
        <div class="history-list" id="historyList"></div>
    </div>

    <div class="main">
        <div class="mobile-header">
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <div class="mobile-header-title">Finance Coach</div>
        </div>

        <div class="chat" id="chat">
            <div class="welcome" id="welcome">
                <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–∞—Ä—å–µ—Ä–Ω—ã–π –ö–æ—É—á</h1>
                <p class="welcome-subtitle">AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º —Å–µ–∫—Ç–æ—Ä–µ</p>
                <div class="welcome-features">
                    <div class="feature-item">ü§ñ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é</div>
                    <div class="feature-item">üîç –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</div>
                    <div class="feature-item">üìà –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                </div>
                <div class="grid">
                    <div class="card card-main" onclick="handleCardClick('–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö')">
                        <div class="card-icon">üíº</div>
                        "–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö"
                        <div class="card-sub">–ò–Ω—Ç–µ—Ä–≤—å—é –∏ –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrap">
                <textarea id="input" rows="1" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." oninput="resize(this)" onkeydown="enter(event)"></textarea>
                <button class="send" id="sendBtn" onclick="sendMsg()" disabled>‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin + '/v1';  // Using versioned API
        let sessionId = localStorage.getItem('sid');
        let sending = false;
        let userId = localStorage.getItem('userId') || null;
        let globalProfileCache = null; // –ö—ç—à –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

        // Toast notifications
        function showToast(message, type = 'info', duration = 4000) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // Progress bar
        function showProgress() {
            const bar = document.getElementById('progressBar');
            if (bar) bar.classList.add('active');
        }
        function hideProgress() {
            const bar = document.getElementById('progressBar');
            if (bar) bar.classList.remove('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('on');
        }
        function closeSidebar() { 
            document.getElementById('sidebar').classList.remove('open'); 
            document.getElementById('overlay').classList.remove('on'); 
        }

        function resize(t) { 
            t.style.height = 'auto'; 
            t.style.height = Math.min(t.scrollHeight, 200) + 'px'; 
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) sendBtn.disabled = !t.value.trim() || sending;
        }
        
        function enter(e) { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMsg(); 
            } 
        }

        function scrollToTop() {
            const chat = document.getElementById('chat');
            if (chat) chat.scrollTop = 0;
        }
        
        function scrollToBottom() { 
            const chat = document.getElementById('chat');
            if (chat) chat.scrollTop = chat.scrollHeight;
        }

        async function retry(url, opt = {}, n = 3) {
            for (let i = 0; i < n; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);
                    const r = await fetch(url, { ...opt, signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (r.status >= 500) throw new Error(`Server error: ${r.status}`);
                    return r;
                } catch (e) { 
                    if (i === n - 1) throw e; 
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
        }

        async function init() {
            showProgress();
            try { 
                // Health endpoints don't use versioning
                await retry(`${window.location.origin}/health`, {}, 5);
                const readyR = await retry(`${window.location.origin}/ready`, {}, 3);
                if (readyR.ok) {
                    const readyData = await readyR.json();
                    if (readyData.ready) {
                        showToast("‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ", "success", 2000);
                    }
                }
            } catch { 
                showToast("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "error"); 
                hideProgress();
                return; 
            }
            
            await loadHistory();
            if (sessionId) await load(sessionId);
            hideProgress();
        }

        async function loadHistory() {
            if (!userId) return;
            try {
                const r = await retry(`${API}/sessions?user_id=${userId}`, {}, 3);
                if (!r.ok) return;
                
                const data = await r.json();
                const sessions = data.sessions || [];
                const historyList = document.getElementById('historyList');
                if (!historyList) return;
                
                sessions.sort((a, b) => new Date(b.last_updated_at || 0) - new Date(a.last_updated_at || 0));
                historyList.innerHTML = '';
                
                if (sessions.length === 0) {
                    historyList.innerHTML = '<div style="padding:15px;color:var(--text-dim);font-size:13px;text-align:center;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
                    return;
                }
                
                sessions.forEach(session => {
                    const item = document.createElement('div');
                    const isActive = session.session_id === sessionId;
                    item.className = 'history-item' + (isActive ? ' active' : '');
                    item.onclick = () => { 
                        closeSidebar(); 
                        load(session.session_id); 
                    };
                    
                    const content = document.createElement('div');
                    content.className = 'history-item-content';
                    content.textContent = session.preview || `–ß–∞—Ç ${session.session_id.substring(0, 8)}`;
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'history-item-delete';
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = (e) => { 
                        e.stopPropagation(); 
                        deleteSession(session.session_id); 
                    };
                    
                    item.appendChild(content);
                    item.appendChild(deleteBtn);
                    historyList.appendChild(item);
                });
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        async function deleteSession(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
            showProgress();
            try {
                const r = await retry(`${API}/sessions/${id}`, { method: 'DELETE' }, 3);
                if (r.ok) {
                    if (sessionId === id) {
                        sessionId = null;
                        localStorage.removeItem('sid');
                        globalProfileCache = null;
                        const chat = document.getElementById('chat');
                        if (chat) chat.innerHTML = getWelcomeHTML();
                    }
                    await loadHistory();
                    showToast("‚úÖ –ß–∞—Ç —É–¥–∞–ª–µ–Ω", "success", 2000);
                }
            } catch (e) {
                showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–∞—Ç", "error");
            } finally {
                hideProgress();
            }
        }

        function getWelcomeHTML() {
            return `
                <div class="welcome" id="welcome">
                    <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–∞—Ä—å–µ—Ä–Ω—ã–π –ö–æ—É—á</h1>
                    <p class="welcome-subtitle">AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º —Å–µ–∫—Ç–æ—Ä–µ</p>
                    <div class="welcome-features">
                        <div class="feature-item">ü§ñ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é</div>
                        <div class="feature-item">üîç –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</div>
                        <div class="feature-item">üìà –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                    </div>
                    <div class="grid">
                        <div class="card card-main" onclick="handleCardClick('–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö')">
                            <div class="card-icon">üíº</div>
                            "–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö"
                            <div class="card-sub">–ò–Ω—Ç–µ—Ä–≤—å—é –∏ –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function newChat() {
            sessionId = null;
            localStorage.removeItem('sid');
            globalProfileCache = null;
            const chat = document.getElementById('chat');
            if (chat) chat.innerHTML = getWelcomeHTML();
            closeSidebar();
            await loadHistory();
        }

        async function createSession(chatType = null) {
            try {
                const payload = userId ? { user_id: userId } : {};
                const r = await retry(`${API}/sessions`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, 5);
                if (!r.ok) throw new Error(`Failed: ${r.status}`);
                
                const d = await r.json();
                sessionId = d.session_id;
                localStorage.setItem('sid', sessionId);
                if (!userId && d.user_id) {
                    userId = d.user_id;
                    localStorage.setItem('userId', userId);
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–∏–ø —á–∞—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                if (chatType && chatType !== '–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö') {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–∏–ø–æ–º —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                    try {
                        await retry(`${API}/chat/${sessionId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: `–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã –≤ —Ä–∞–∑–¥–µ–ª–µ: ${chatType}` })
                        }, 2);
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                    }
                }
                
                // –ñ–¥—ë–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                for (let i = 0; i < 5; i++) {
                    await new Promise(r => setTimeout(r, 500));
                    await load(sessionId);
                    if (document.querySelector('.msg.ai')) break;
                }
                await loadHistory();
                return sessionId;
            } catch (e) {
                console.error('Create session failed:', e);
                throw e;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ—Ñ–∏–ª—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ –ª—é–±–æ–π —Å–µ—Å—Å–∏–∏)
        async function checkExistingProfile() {
            if (globalProfileCache) return globalProfileCache;
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
            if (sessionId) {
                try {
                    const r = await retry(`${API}/profile/${sessionId}`, {}, 2);
                    if (r.ok) {
                        const data = await r.json();
                        globalProfileCache = data.profile;
                        return globalProfileCache;
                    }
                } catch (e) {}
            }
            
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ user_id (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
            if (userId) {
                try {
                    const r = await retry(`${API}/profile/by-user/${userId}`, {}, 2);
                    if (r.ok) {
                        const data = await r.json();
                        globalProfileCache = data.profile;
                        return globalProfileCache;
                    }
                } catch (e) {}
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ user_id, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ —Å–µ—Å—Å–∏–∏
                try {
                    const sessionsR = await retry(`${API}/sessions?user_id=${userId}`, {}, 2);
                    if (sessionsR.ok) {
                        const sessionsData = await sessionsR.json();
                        const sessions = sessionsData.sessions || [];
                        
                        for (const sess of sessions) {
                            if (sess.session_id === sessionId) continue;
                            try {
                                const r = await retry(`${API}/profile/${sess.session_id}`, {}, 1);
                                if (r.ok) {
                                    const data = await r.json();
                                    globalProfileCache = data.profile;
                                    return globalProfileCache;
                                }
                            } catch (e) {}
                        }
                    }
                } catch (e) {}
            }
            
            return null;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —á–∞—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
        let currentChatType = null;
        
        async function handleCardClick(text) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.style.display = 'none';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
            currentChatType = text;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ—Ñ–∏–ª—å
            const existingProfile = await checkExistingProfile();
            
            if (text === '–†–∞–∑–≤–∏—Ç–∏–µ –∫–∞—Ä—å–µ—Ä—ã' || text === '–ê–Ω–∞–ª–∏–∑ –Ω–∞–≤—ã–∫–æ–≤' || text === '–ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π') {
                if (existingProfile) {
                    // –ü—Ä–æ—Ñ–∏–ª—å –µ—Å—Ç—å - –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é –∑–∞–Ω–æ–≤–æ
                    if (!sessionId) {
                        typing();
                        showProgress();
                        try {
                            await createSession();
                        } catch (e) {
                            untype();
                            hideProgress();
                            showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é", "error");
                            if (welcome) welcome.style.display = 'flex';
                            return;
                        }
                        untype();
                        hideProgress();
                    }
                    
                    if (!sessionId) {
                        typing();
                        showProgress();
                        try {
                            await createSession(text);
                        } catch (e) {
                            untype();
                            hideProgress();
                            showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é", "error");
                            if (welcome) welcome.style.display = 'flex';
                            return;
                        }
                        untype();
                        hideProgress();
                    }
                    
                    if (text === '–†–∞–∑–≤–∏—Ç–∏–µ –∫–∞—Ä—å–µ—Ä—ã') {
                        await handleCareerPlanWithProfile(existingProfile);
                    } else if (text === '–ê–Ω–∞–ª–∏–∑ –Ω–∞–≤—ã–∫–æ–≤') {
                        await handleSkillsWithProfile(existingProfile);
                    } else if (text === '–ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π') {
                        await handleGoalsWithProfile(existingProfile);
                    }
                    return;
                } else {
                    // –ü—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    if (!sessionId) {
                        typing();
                        showProgress();
                        try {
                            await createSession(text);
                        } catch (e) {
                            untype();
                            hideProgress();
                            showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é", "error");
                            if (welcome) welcome.style.display = 'flex';
                            return;
                        }
                        untype();
                        hideProgress();
                    }
                    add('assistant', `üìã –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ "${text}" —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ —Ä–∞–∑–¥–µ–ª–µ "–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö".\n\n–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—É—á–∞.`);
                    actions();
                    return;
                }
            }
            
            // –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ "–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö" - —Å–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é –∏ –ø—Ä–æ—Ö–æ–¥–∏–º –∏–Ω—Ç–µ—Ä–≤—å—é
            if (!sessionId) {
                try {
                    typing();
                    showProgress();
                    await createSession();
                    untype();
                    hideProgress();
                } catch (e) {
                    untype();
                    hideProgress();
                    showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é", "error");
                    if (welcome) welcome.style.display = 'flex';
                }
            }
        }

        async function handleCareerPlanWithProfile(profile) {
            const currentPosition = profile.professional_context?.professional_role || '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç';
            add('assistant', `üéØ –û—Ç–ª–∏—á–Ω–æ! –Ø –≤–∏–∂—É –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, —á—Ç–æ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –∫–∞–∫ **${currentPosition}**.\n\n–ß—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã, —É–∫–∞–∂–∏—Ç–µ:\n\n1. **–ö–µ–º —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å?** (–Ω–∞–ø—Ä–∏–º–µ—Ä: CFO, –î–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º)\n2. **–í –∫–∞–∫–æ–π —Å—Ñ–µ—Ä–µ?** (–±–∞–Ω–∫–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, —Ñ–∏–Ω—Ç–µ—Ö)\n3. **–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å?** (senior, lead, director)\n\n–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ü–µ–ª–∏ –≤ —á–∞—Ç, –∏ —è —Å–æ—Å—Ç–∞–≤–ª—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è —Å –∫—É—Ä—Å–∞–º–∏ –∏ –≤–∞–∫–∞–Ω—Å–∏—è–º–∏.`);
            actions();
        }

        async function handleSkillsWithProfile(profile) {
            const currentPosition = profile.professional_context?.professional_role || '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç';
            const currentSkills = profile.skills?.hard_skills || [];
            const currentTools = profile.skills?.tools || [];
            
            let skillsHtml = `<div class="profile-card">`;
            skillsHtml += `<div class="profile-section-title">üìä –ê–Ω–∞–ª–∏–∑ –Ω–∞–≤—ã–∫–æ–≤</div>`;
            skillsHtml += `<div class="profile-section">`;
            skillsHtml += `<div class="profile-section-title">üë§ –í–∞—à —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å</div>`;
            skillsHtml += `<div class="profile-item"><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> ${currentPosition}</div>`;
            
            if (currentSkills.length > 0) {
                skillsHtml += `<div class="profile-item"><strong>–í–∞—à–∏ –Ω–∞–≤—ã–∫–∏:</strong></div>`;
                skillsHtml += `<div style="margin-top: 8px;">`;
                currentSkills.forEach(s => skillsHtml += `<span class="profile-tag">${s}</span>`);
                skillsHtml += `</div>`;
            }
            
            if (currentTools.length > 0) {
                skillsHtml += `<div class="profile-item" style="margin-top: 12px;"><strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</strong> ${currentTools.join(', ')}</div>`;
            }
            
            skillsHtml += `</div>`;
            skillsHtml += `<div class="profile-section">`;
            skillsHtml += `<div class="profile-section-title">üéØ –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞–≤—ã–∫–æ–≤</div>`;
            skillsHtml += `<div class="profile-item">–£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –ø–æ–∑–∏—Ü–∏—é, –∏ —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é:</div>`;
            skillsHtml += `<div class="profile-item">‚úì –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å</div>`;
            skillsHtml += `<div class="profile-item">‚úì –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–≤–∏—Ç—å</div>`;
            skillsHtml += `<div class="profile-item">‚úì –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å —Ä–∞–∑–≤–∏—Ç–∏—è –Ω–∞–≤—ã–∫–æ–≤</div>`;
            skillsHtml += `<div class="profile-item">‚úì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—É—á–µ–Ω–∏—é</div>`;
            skillsHtml += `</div>`;
            skillsHtml += `</div>`;
            
            addHTML('assistant', skillsHtml);
            add('assistant', '\n**–î–ª—è –∫–∞–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –Ω–∞–≤—ã–∫–∏?**\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: CFO, –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä, –î–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º, –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–µ—Ä, –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫');
            actions();
        }

        async function handleGoalsWithProfile(profile) {
            const currentPosition = profile.professional_context?.professional_role || '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç';
            const currentField = profile.professional_context?.professional_field || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            const goals = profile.goals || {};
            
            let goalsHtml = `<div class="profile-card">`;
            goalsHtml += `<div class="profile-section-title">üéØ –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö —Ü–µ–ª–µ–π</div>`;
            goalsHtml += `<div class="profile-section">`;
            goalsHtml += `<div class="profile-section-title">üìç –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</div>`;
            goalsHtml += `<div class="profile-item"><strong>–†–æ–ª—å:</strong> ${currentPosition}</div>`;
            goalsHtml += `<div class="profile-item"><strong>–°—Ñ–µ—Ä–∞:</strong> ${currentField}</div>`;
            if (profile.professional_context?.seniority_level) {
                goalsHtml += `<div class="profile-item"><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${profile.professional_context.seniority_level}</div>`;
            }
            goalsHtml += `</div>`;
            
            if (goals.desired_role || goals.target_field) {
                goalsHtml += `<div class="profile-section">`;
                goalsHtml += `<div class="profile-section-title">üéØ –£–∂–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏</div>`;
                if (goals.desired_role) goalsHtml += `<div class="profile-item"><strong>–¶–µ–ª–µ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:</strong> ${goals.desired_role}</div>`;
                if (goals.target_field) goalsHtml += `<div class="profile-item"><strong>–¶–µ–ª–µ–≤–∞—è —Å—Ñ–µ—Ä–∞:</strong> ${goals.target_field}</div>`;
                if (goals.desired_level) goalsHtml += `<div class="profile-item"><strong>–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</strong> ${goals.desired_level}</div>`;
                goalsHtml += `</div>`;
            }
            
            goalsHtml += `<div class="profile-section">`;
            goalsHtml += `<div class="profile-section-title">üîç –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π</div>`;
            goalsHtml += `<div class="profile-item">–Ø –ø—Ä–æ–≤–µ–¥—É –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö —Ü–µ–ª–µ–π:</div>`;
            goalsHtml += `<div class="profile-item">‚úì SWOT-–∞–Ω–∞–ª–∏–∑ (—Å–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏/—Ä–∏—Å–∫–∏)</div>`;
            goalsHtml += `<div class="profile-item">‚úì –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å —Ü–µ–ª–µ–π</div>`;
            goalsHtml += `<div class="profile-item">‚úì –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>`;
            goalsHtml += `<div class="profile-item">‚úì –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è</div>`;
            goalsHtml += `<div class="profile-item">‚úì –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏</div>`;
            goalsHtml += `</div>`;
            goalsHtml += `</div>`;
            
            addHTML('assistant', goalsHtml);
            add('assistant', '\n**–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –∫–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏ –ø–æ–¥—Ä–æ–±–Ω–æ:**\n\n1. –ö—É–¥–∞ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è?\n2. –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å?\n3. –í –∫–∞–∫–æ–π —Å—Ñ–µ—Ä–µ –≤–∏–¥–∏—Ç–µ —Å–µ–±—è —á–µ—Ä–µ–∑ 3-5 –ª–µ—Ç?\n4. –ö–∞–∫–∏–µ —É –≤–∞—Å –∞–º–±–∏—Ü–∏–∏ –∏ –æ–∂–∏–¥–∞–Ω–∏—è?');
            actions();
        }

        async function load(id) {
            sessionId = id;
            localStorage.setItem('sid', id);
            
            try {
                const r = await retry(`${API}/sessions/${id}`, {}, 3);
                if (!r.ok) { 
                    if (r.status === 404) {
                        localStorage.removeItem('sid');
                        sessionId = null;
                    }
                    return; 
                }
                const d = await r.json();
                const msgs = d.messages || [];
                
                const chat = document.getElementById('chat');
                if (!chat) return;
                
                chat.innerHTML = '';
                
                if (msgs.length) {
                    const welcome = document.getElementById('welcome');
                    if (welcome) welcome.style.display = 'none';
                    
                    msgs.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
                    msgs.forEach(m => {
                        const role = m.role === 'user' ? 'user' : 'assistant';
                        add(role, m.content, false);
                    });
                    scrollToBottom();
                    
                    const lastMsg = msgs[msgs.length - 1];
                    if (lastMsg && lastMsg.done && !chat.querySelector('.action-buttons')) {
                        actions();
                    }
                } else {
                    chat.innerHTML = getWelcomeHTML();
                }
                
                await loadHistory(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            } catch (e) {
                console.error('Load failed:', e);
            }
        }

        async function sendMsg() {
            const inp = document.getElementById('input');
            if (!inp) return;
            
            const txt = inp.value.trim();
            if (!txt || sending) return;
            if (txt.length > 5000) {
                showToast("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ", "warning");
                return;
            }

            inp.value = '';
            inp.style.height = 'auto';
            document.getElementById('sendBtn').disabled = true;
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.style.display = 'none';
            
            add('user', txt);
            sending = true;
            typing();

            try {
                if (!sessionId) await createSession();
                if (!sessionId) throw new Error("No session");

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç - –µ—Å–ª–∏ –∂–¥—ë–º —Ü–µ–ª–∏ –¥–ª—è –ø–ª–∞–Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏—è
                const chat = document.getElementById('chat');
                const lastAiMsg = Array.from(chat?.querySelectorAll('.msg.ai .msg-content') || []).pop();
                const lastAiText = lastAiMsg?.textContent || '';
                
                if (lastAiText.includes('–ö–µ–º —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å') || lastAiText.includes('–ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è') || lastAiText.includes('—Ü–µ–ª–∏ –≤ —á–∞—Ç')) {
                    await createCareerPlanFromGoals(txt);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–≤—ã–∫–æ–≤
                if (lastAiText.includes('–î–ª—è –∫–∞–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏') || lastAiText.includes('–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –Ω–∞–≤—ã–∫–∏') || lastAiText.includes('–ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞–≤—ã–∫–æ–≤')) {
                    await analyzeSkillsForPosition(txt);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ü–µ–ª–µ–π
                if (lastAiText.includes('–∫–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏') || lastAiText.includes('–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π') || lastAiText.includes('–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –∫–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏')) {
                    await analyzeCareerGoals(txt);
                    return;
                }

                const r = await retry(`${API}/chat/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: txt })
                }, 5);

                if (!r.ok) throw new Error(`Chat failed: ${r.status}`);

                const d = await r.json();
                untype();
                add('assistant', d.reply || '');
                if (d.done) actions();

            } catch (e) {
                untype();
                showToast("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", "error");
                inp.value = txt;
                document.getElementById('sendBtn').disabled = false;
            } finally {
                sending = false;
            }
        }

        async function handleProfileAction() {
            typing();
            showProgress();
            try {
                const r = await retry(`${API}/profile/${sessionId}`, {}, 3);
                untype();
                hideProgress();
                
                if (!r.ok) {
                    add('system', "‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é.");
                    actions();
                    return;
                }
                
                const data = await r.json();
                const profile = data.profile;
                globalProfileCache = profile;
                
                let html = '<div class="profile-card">';
                
                // –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                if (profile.professional_context) {
                    const pc = profile.professional_context;
                    html += '<div class="profile-section">';
                    html += '<div class="profile-section-title">üë§ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</div>';
                    if (pc.professional_role) html += `<div class="profile-item"><strong>–†–æ–ª—å:</strong> ${pc.professional_role}</div>`;
                    if (pc.professional_field) html += `<div class="profile-item"><strong>–°—Ñ–µ—Ä–∞:</strong> ${pc.professional_field}</div>`;
                    if (pc.specialization) html += `<div class="profile-item"><strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> ${pc.specialization}</div>`;
                    if (pc.seniority_level) html += `<div class="profile-item"><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${pc.seniority_level}</div>`;
                    html += '</div>';
                }
                
                // –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã
                if (profile.resume && profile.resume.length > 0) {
                    html += '<div class="profile-section">';
                    html += '<div class="profile-section-title">üíº –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</div>';
                    profile.resume.forEach(job => {
                        html += `<div class="profile-item"><strong>${job.title || '–î–æ–ª–∂–Ω–æ—Å—Ç—å'}</strong> –≤ ${job.company || '–ö–æ–º–ø–∞–Ω–∏—è'}`;
                        if (job.start_date) html += ` (${job.start_date}${job.end_date ? ' ‚Äî ' + job.end_date : ' ‚Äî –ø–æ –Ω.–≤.'})`;
                        html += '</div>';
                        if (job.tasks && job.tasks.length) {
                            html += `<div class="profile-item" style="font-size:13px;color:var(--text-dim)">–ó–∞–¥–∞—á–∏: ${job.tasks.slice(0,3).join(', ')}</div>`;
                        }
                        if (job.achievements && job.achievements.length) {
                            html += `<div class="profile-item" style="font-size:13px;color:var(--success)">‚úì ${job.achievements.slice(0,2).join(', ')}</div>`;
                        }
                    });
                    html += '</div>';
                }
                
                // –ù–∞–≤—ã–∫–∏
                if (profile.skills) {
                    const sk = profile.skills;
                    html += '<div class="profile-section">';
                    html += '<div class="profile-section-title">üõ†Ô∏è –ù–∞–≤—ã–∫–∏ –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏</div>';
                    if (sk.hard_skills && sk.hard_skills.length) {
                        html += '<div style="margin-bottom:8px">';
                        sk.hard_skills.forEach(s => html += `<span class="profile-tag">${s}</span>`);
                        html += '</div>';
                    }
                    if (sk.tools && sk.tools.length) {
                        html += `<div class="profile-item"><strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</strong> ${sk.tools.join(', ')}</div>`;
                    }
                    if (sk.certifications && sk.certifications.length) {
                        html += `<div class="profile-item"><strong>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã:</strong> ${sk.certifications.join(', ')}</div>`;
                    }
                    if (sk.education && sk.education.length) {
                        html += `<div class="profile-item"><strong>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:</strong> ${sk.education.join(', ')}</div>`;
                    }
                    html += '</div>';
                }
                
                // –¶–µ–ª–∏
                if (profile.goals) {
                    const g = profile.goals;
                    html += '<div class="profile-section">';
                    html += '<div class="profile-section-title">üéØ –ö–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏</div>';
                    if (g.desired_role) html += `<div class="profile-item"><strong>–¶–µ–ª–µ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:</strong> ${g.desired_role}</div>`;
                    if (g.target_field) html += `<div class="profile-item"><strong>–¶–µ–ª–µ–≤–∞—è —Å—Ñ–µ—Ä–∞:</strong> ${g.target_field}</div>`;
                    if (g.desired_level) html += `<div class="profile-item"><strong>–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</strong> ${g.desired_level}</div>`;
                    if (g.salary_expectation && g.salary_expectation.min) {
                        const sal = g.salary_expectation;
                        html += `<div class="profile-item"><strong>–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è:</strong> ${sal.min?.toLocaleString()}${sal.max ? ' ‚Äî ' + sal.max.toLocaleString() : '+'} ${sal.currency || 'RUR'}</div>`;
                    }
                    html += '</div>';
                }
                
                // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                if (profile.achievements && profile.achievements.length) {
                    html += '<div class="profile-section">';
                    html += '<div class="profile-section-title">üèÜ –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>';
                    profile.achievements.forEach(a => html += `<div class="profile-item">‚úì ${a}</div>`);
                    html += '</div>';
                }
                
                html += '</div>';
                
                addHTML('assistant', html, false);
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∫–Ω–æ–ø–æ–∫ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
                setTimeout(() => {
                    actions();
                }, 100);
            } catch (e) {
                untype();
                hideProgress();
                add('system', "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å");
                actions();
            }
        }

        async function handleVacanciesAction() {
            typing();
            showProgress();
            try {
                const r = await retry(`${API}/match/vacancies/by-session/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ k_faiss: 100, k_stage1: 30, k_stage2: 15 })
                }, 3);
                untype();
                hideProgress();
                
                if (!r.ok) {
                    add('system', "‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é.");
                    actions();
                    return;
                }
                
                const data = await r.json();
                const vacancies = data.result || [];
                
                if (vacancies.length === 0) {
                    add('assistant', "üîç –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è.");
                    actions();
                    return;
                }
                
                // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –≤–∞–∫–∞–Ω—Å–∏–∏ (1-5)
                function getVacancyLevel(vac) {
                    const title = (vac.title || '').toLowerCase();
                    const exp = (vac.experience || '').toLowerCase();
                    const desc = (vac.description || '').toLowerCase();
                    
                    // –£—Ä–æ–≤–µ–Ω—å 1: –°—Ç–∞–∂–µ—Ä, Intern, –±–µ–∑ –æ–ø—ã—Ç–∞
                    if (title.includes('—Å—Ç–∞–∂–µ—Ä') || title.includes('intern') || title.includes('trainee') || 
                        exp.includes('–±–µ–∑ –æ–ø—ã—Ç–∞') || exp.includes('–Ω–µ—Ç –æ–ø—ã—Ç–∞')) {
                        return { level: 1, label: '–ù–∞—á–∞–ª—å–Ω—ã–π', color: '#22c55e' };
                    }
                    
                    // –£—Ä–æ–≤–µ–Ω—å 2: Junior, –¥–æ 1 –≥–æ–¥–∞ –æ–ø—ã—Ç–∞
                    if (title.includes('junior') || title.includes('–º–ª–∞–¥—à–∏–π') || 
                        exp.includes('–¥–æ 1 –≥–æ–¥–∞') || exp.includes('1 –≥–æ–¥')) {
                        return { level: 2, label: '–ú–ª–∞–¥—à–∏–π', color: '#10a37f' };
                    }
                    
                    // –£—Ä–æ–≤–µ–Ω—å 3: Middle, 1-3 –≥–æ–¥–∞ –æ–ø—ã—Ç–∞
                    if (title.includes('middle') || title.includes('—Å—Ä–µ–¥–Ω–∏–π') || 
                        exp.includes('–æ—Ç 1 –≥–æ–¥–∞') || exp.includes('1-3 –≥–æ–¥–∞') || exp.includes('–¥–æ 3 –ª–µ—Ç')) {
                        return { level: 3, label: '–°—Ä–µ–¥–Ω–∏–π', color: '#fbbf24' };
                    }
                    
                    // –£—Ä–æ–≤–µ–Ω—å 4: Senior, Lead, 3-6 –ª–µ—Ç –æ–ø—ã—Ç–∞
                    if (title.includes('senior') || title.includes('lead') || title.includes('—Å—Ç–∞—Ä—à–∏–π') || title.includes('–≤–µ–¥—É—â–∏–π') ||
                        exp.includes('–æ—Ç 3 –ª–µ—Ç') || exp.includes('3-6 –ª–µ—Ç') || exp.includes('–±–æ–ª–µ–µ 3 –ª–µ—Ç')) {
                        return { level: 4, label: '–°—Ç–∞—Ä—à–∏–π', color: '#f97316' };
                    }
                    
                    // –£—Ä–æ–≤–µ–Ω—å 5: Director, Head, CFO, –±–æ–ª–µ–µ 6 –ª–µ—Ç
                    if (title.includes('director') || title.includes('head') || title.includes('–¥–∏—Ä–µ–∫—Ç–æ—Ä') || title.includes('—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å') ||
                        title.includes('cfo') || title.includes('ceo') || exp.includes('–±–æ–ª–µ–µ 6 –ª–µ—Ç') || exp.includes('–æ—Ç 6 –ª–µ—Ç')) {
                        return { level: 5, label: '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π', color: '#ef4444' };
                    }
                    
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
                    return { level: 3, label: '–°—Ä–µ–¥–Ω–∏–π', color: '#fbbf24' };
                }
                
                let html = `<div><strong>üîç –ù–∞–π–¥–µ–Ω–æ ${vacancies.length} –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π:</strong></div><br>`;
                
                vacancies.slice(0, 15).forEach((vac, idx) => {
                    const levelInfo = getVacancyLevel(vac);
                    const descPreview = vac.description ? 
                        (vac.description.length > 200 ? vac.description.substring(0, 200) + '...' : vac.description) : '';
                    
                    html += `<div class="vacancy-card">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">`;
                    html += `<div class="vacancy-title" style="flex: 1;">${idx + 1}. ${vac.title || '–í–∞–∫–∞–Ω—Å–∏—è'}</div>`;
                    html += `<span class="vacancy-level-badge" style="background: ${levelInfo.color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; margin-left: 12px;">${levelInfo.level}/5 ${levelInfo.label}</span>`;
                    html += `</div>`;
                    if (vac.company) html += `<div class="vacancy-info">üè¢ ${vac.company}</div>`;
                    if (vac.location) html += `<div class="vacancy-info">üìç ${vac.location}</div>`;
                    if (vac.salary) html += `<div class="vacancy-info">üí∞ ${vac.salary}</div>`;
                    if (vac.experience) html += `<div class="vacancy-info">‚è≥ ${vac.experience}</div>`;
                    if (descPreview) {
                        html += `<div class="vacancy-description" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 13px; color: var(--text-dim); line-height: 1.5;">${descPreview}</div>`;
                    }
                    if (vac.key_skills) {
                        const skills = vac.key_skills.split(',').slice(0, 5).join(', ');
                        html += `<div class="vacancy-info" style="margin-top: 8px;"><strong>–ù–∞–≤—ã–∫–∏:</strong> ${skills}</div>`;
                    }
                    if (vac.hh_url) {
                        html += `<a href="${vac.hh_url}" target="_blank" rel="noopener" class="vacancy-link">üîó –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ hh.ru</a>`;
                    }
                    html += `</div>`;
                });
                
                addHTML('assistant', html, false);
                scrollToFirstVacancy();
                setTimeout(() => {
                    actions();
                }, 200);
            } catch (e) {
                untype();
                hideProgress();
                add('system', "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∞–∫–∞–Ω—Å–∏–∏");
                actions();
            }
        }
        
        function scrollToFirstVacancy() {
            setTimeout(() => {
                const chat = document.getElementById('chat');
                const firstVacancy = document.querySelector('.vacancy-card');
                if (firstVacancy && chat) {
                    // –°–∫—Ä–æ–ª–ª–∏–º –∫ –ø–µ—Ä–≤–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏, –Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º —Å–≤–µ—Ä—Ö—É
                    const rect = firstVacancy.getBoundingClientRect();
                    const chatRect = chat.getBoundingClientRect();
                    const scrollTop = chat.scrollTop + rect.top - chatRect.top - 20;
                    chat.scrollTo({ top: scrollTop, behavior: 'smooth' });
                } else {
                    // –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–∫—Ä–æ–ª–ª–∏–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                    if (chat) chat.scrollTop = 0;
                }
            }, 200);
        }

        async function handleCareerPlanAction() {
            const profile = await checkExistingProfile();
            
            if (profile) {
                await handleCareerPlanWithProfile(profile);
            } else {
                add('assistant', "üéØ –ß—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã, —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –∏–Ω—Ç–µ—Ä–≤—å—é –∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **–ü—Ä–æ—Ñ–∏–ª—å** –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç.");
                actions();
            }
        }

        async function analyzeSkillsForPosition(position) {
            typing();
            showProgress();
            
            try {
                const profile = await checkExistingProfile();
                if (!profile) {
                    untype();
                    hideProgress();
                    add('system', "‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    actions();
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–≤—ã–∫–æ–≤
                const currentRole = profile.professional_context?.professional_role || '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç';
                const currentSkills = profile.skills?.hard_skills || [];
                const currentTools = profile.skills?.tools || [];
                
                const analysisPrompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ–¥–∏ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –∞–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞–≤—ã–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏.

–¢–ï–ö–£–©–ò–ô –ü–†–û–§–ò–õ–¨:
- –ü–æ–∑–∏—Ü–∏—è: ${currentRole}
- –ù–∞–≤—ã–∫–∏: ${currentSkills.join(', ') || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: ${currentTools.join(', ') || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}

–¶–ï–õ–ï–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø: "${position}"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—ã –î–û–õ–ñ–ï–ù –¥–∞—Ç—å –î–ï–¢–ê–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑. –ù–ï –≥–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ "—Å–ø–∞—Å–∏–±–æ" –∏–ª–∏ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã. –î–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –∏ –ü–û–õ–ï–ó–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. –ù–ê–í–´–ö–ò, –ö–û–¢–û–†–´–ï –£ –í–ê–° –£–ñ–ï –ï–°–¢–¨ (–º–∏–Ω–∏–º—É–º 5-7, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ):
   - –ü–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï –Ω–∞–≤—ã–∫–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ "${position}"
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–≤—ã–∫–∞ —É–∫–∞–∂–∏—Ç–µ:
     * –£—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è (–Ω–∞—á–∞–ª—å–Ω—ã–π/—Å—Ä–µ–¥–Ω–∏–π/–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)
     * –ö–∞–∫ —ç—Ç–æ—Ç –Ω–∞–≤—ã–∫ –ø–æ–º–æ–∂–µ—Ç –≤ —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
     * –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ —ç—Ç–æ–º –Ω–∞–≤—ã–∫–µ

2. –ù–ê–í–´–ö–ò, –ö–û–¢–û–†–´–ï –ù–£–ñ–ù–û –†–ê–ó–í–ò–¢–¨ (–º–∏–Ω–∏–º—É–º 7-10, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ):
   - –ü–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï –Ω–∞–≤—ã–∫–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ "${position}", –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–≤—ã–∫–∞ —É–∫–∞–∂–∏—Ç–µ:
     * –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å —Ä–∞–∑–≤–∏—Ç–∏—è (–≤—ã—Å–æ–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–Ω–∏–∑–∫–∏–π) –∏ –ø–æ—á–µ–º—É
     * –ü–æ—á–µ–º—É —ç—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è "${position}"
     * –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å (–Ω–∞—á–∞–ª—å–Ω—ã–π/—Å—Ä–µ–¥–Ω–∏–π/–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)

3. –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ê–ó–í–ò–¢–ò–Ø –ù–ê–í–´–ö–û–í (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –Ω–∞–≤—ã–∫–∞):
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫—É—Ä—Å—ã –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—É—á–µ–Ω–∏—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ–≤–∞–π–¥–µ—Ä, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ (–æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –∫–∞–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª—É—á–∏—Ç—å)
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –¥–ª—è –æ—Å–≤–æ–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "2-3 –º–µ—Å—è—Ü–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è")
   - –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ (–∫–∞–∫ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –Ω–∞–≤—ã–∫ –æ—Å–≤–æ–µ–Ω)

4. –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –û–ë–£–ß–ï–ù–ò–Æ:
   - –¢–æ–ø-7 –∫—É—Ä—Å–æ–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
   - –¢–æ–ø-5 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ (–¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ)
   - –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –ø–æ–ª—É—á–∏—Ç—å (CFA, FRM, ACCA –∏ —Ç.–¥.) –∏ –ø–æ—á–µ–º—É
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (–∫–Ω–∏–≥–∏, –≤–µ–±–∏–Ω–∞—Ä—ã, —Å–æ–æ–±—â–µ—Å—Ç–≤–∞)

5. –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø –†–ê–ó–í–ò–¢–ò–Ø:
   - –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å (–ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞)
   - –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –≤–æ –≤—Ç–æ—Ä—É—é –æ—á–µ—Ä–µ–¥—å (3-6 –º–µ—Å—è—Ü–µ–≤)
   - –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –≤ —Ç—Ä–µ—Ç—å—é –æ—á–µ—Ä–µ–¥—å (6-12 –º–µ—Å—è—Ü–µ–≤)

–í–ê–ñ–ù–û: 
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ú, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –º–µ—Ç—Ä–∏–∫–∏
- –ù–ï –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –æ—Ç–≤–µ—Ç –ø—Ä–æ—Å—Ç–æ "—Å–ø–∞—Å–∏–±–æ" - –¥–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5-7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤`;
                
                const r = await retry(`${API}/chat/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: analysisPrompt })
                }, 3);
                
                untype();
                hideProgress();
                
                if (!r.ok) throw new Error(`Analysis failed: ${r.status}`);
                
                const d = await r.json();
                const analysisResult = d.reply || '';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—Ä–∞—Å–∏–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                let html = `<div class="profile-card">`;
                html += `<div class="profile-section-title">üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞–≤—ã–∫–æ–≤ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏: ${position}</div>`;
                html += `<div class="profile-section">`;
                html += `<div class="profile-item" style="white-space: pre-wrap; line-height: 1.8;">${analysisResult.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
                html += `</div></div>`;
                
                addHTML('assistant', html);
                actions();
            } catch (e) {
                untype();
                hideProgress();
                add('system', "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫–∏");
                actions();
            }
        }
        
        async function analyzeCareerGoals(goalsText) {
            typing();
            showProgress();
            
            try {
                const profile = await checkExistingProfile();
                if (!profile) {
                    untype();
                    hideProgress();
                    add('system', "‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –≤ —Ä–∞–∑–¥–µ–ª–µ '–•–æ—á—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö'.");
                    actions();
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ü–µ–ª–µ–π
                const currentRole = profile.professional_context?.professional_role || '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç';
                const currentField = profile.professional_context?.professional_field || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                const currentSkills = profile.skills?.hard_skills?.join(', ') || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã';
                
                const analysisPrompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ–¥–∏ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ì–õ–£–ë–û–ö–ò–ô –∏ –î–ï–¢–ê–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑ –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö —Ü–µ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–¢–ï–ö–£–©–ò–ô –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
- –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è: ${currentRole}
- –°—Ñ–µ—Ä–∞: ${currentField}
- –ù–∞–≤—ã–∫–∏: ${currentSkills.join(', ') || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}

–ö–ê–†–¨–ï–†–ù–´–ï –¶–ï–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
"${goalsText}"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—ã –î–û–õ–ñ–ï–ù –¥–∞—Ç—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑. –ù–ï –≥–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ "—Å–ø–∞—Å–∏–±–æ" –∏–ª–∏ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã. –î–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –∏ –ü–û–õ–ï–ó–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ–¥–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞–π –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. SWOT-–ê–ù–ê–õ–ò–ó (–¥–µ—Ç–∞–ª—å–Ω–æ, –º–∏–Ω–∏–º—É–º –ø–æ 5 –ø—É–Ω–∫—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Ä–∞–∑–¥–µ–ª–µ):
   - –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´ (–º–∏–Ω–∏–º—É–º 5-7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤):
     * –ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–µ–π
     * –î–ª—è –∫–∞–∂–¥–æ–π —Å–∏–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫ –æ–Ω–∞ –ø–æ–º–æ–∂–µ—Ç
   
   - –°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´ (–º–∏–Ω–∏–º—É–º 5-7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤):
     * –ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–º–µ—à–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —Ü–µ–ª–µ–π
     * –î–ª—è –∫–∞–∂–¥–æ–π —Å–ª–∞–±–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —É–ª—É—á—à–µ–Ω–∏—è
   
   - –í–û–ó–ú–û–ñ–ù–û–°–¢–ò –î–õ–Ø –†–ê–ó–í–ò–¢–ò–Ø (–º–∏–Ω–∏–º—É–º 5-7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤):
     * –ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—Ä—ã–Ω–æ—á–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã, —Ä–∞—Å—Ç—É—â–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)
     * –î–ª—è –∫–∞–∂–¥–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫ –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   
   - –†–ò–°–ö–ò –ò –ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø (–º–∏–Ω–∏–º—É–º 5-7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤):
     * –ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Ä–∏—Å–∫–∏ –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –Ω–∞ –ø—É—Ç–∏ –∫ —Ü–µ–ª—è–º
     * –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Å–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏

2. –û–¶–ï–ù–ö–ê –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–°–¢–ò –¶–ï–õ–ï–ô (–¥–µ—Ç–∞–ª—å–Ω–æ):
   - –ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã —Ü–µ–ª–∏ (–æ—Ü–µ–Ω–∫–∞ 1-10 —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º)
   - –ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–µ–π (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã, –º–∏–Ω–∏–º—É–º 5-7)
   - –ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–µ—à–∞—Ç—å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è, –º–∏–Ω–∏–º—É–º 5-7)
   - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π —á–µ—Ä–µ–∑ 1 –≥–æ–¥ / 3 –≥–æ–¥–∞ / 5 –ª–µ—Ç

3. –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù –î–û–°–¢–ò–ñ–ï–ù–ò–Ø (–¥–µ—Ç–∞–ª—å–Ω–æ, –º–∏–Ω–∏–º—É–º 8-10 —à–∞–≥–æ–≤):
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —É–∫–∞–∂–∏:
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–µ–ª–∞—Ç—å)
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ (–∫–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å)
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å (–≤—ã—Å–æ–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–Ω–∏–∑–∫–∏–π)
   - –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã (–≤—Ä–µ–º—è, –¥–µ–Ω—å–≥–∏, –∫—É—Ä—Å—ã, –ø—Ä–æ–µ–∫—Ç—ã)
   - –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ (–∫–∞–∫ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω)
   - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–æ—Ç –∫–∞–∫–∏—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤ –∑–∞–≤–∏—Å–∏—Ç)

4. –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –ü–£–¢–ò –†–ê–ó–í–ò–¢–ò–Ø (–¥–µ—Ç–∞–ª—å–Ω–æ, –º–∏–Ω–∏–º—É–º 3-4 –≤–∞—Ä–∏–∞–Ω—Ç–∞):
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É—Ç–∏ —É–∫–∞–∂–∏:
   - –û–ø–∏—Å–∞–Ω–∏–µ –ø—É—Ç–∏ (–¥–µ—Ç–∞–ª—å–Ω–æ–µ)
   - –ü–ª—é—Å—ã (–º–∏–Ω–∏–º—É–º 3-5)
   - –ú–∏–Ω—É—Å—ã (–º–∏–Ω–∏–º—É–º 3-5)
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
   - –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ (–º–∏–Ω–∏–º—É–º 5-7)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (–∫–∞–∫–æ–π –ø—É—Ç—å –ª—É—á—à–µ –∏ –ø–æ—á–µ–º—É)

5. –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ):
   - –ù–ê–í–´–ö–ò –î–õ–Ø –†–ê–ó–í–ò–¢–ò–Ø (—Ç–æ–ø-10 —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏):
     * –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å (–ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞)
     * –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏—Ç—å –≤–æ –≤—Ç–æ—Ä—É—é –æ—á–µ—Ä–µ–¥—å (3-6 –º–µ—Å—è—Ü–µ–≤)
     * –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫—É—Ä—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–≤—ã–∫–∞
   
   - –ö–£–†–°–´ –ò –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ (—Ç–æ–ø-10):
     * –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫—É—Ä—Å–æ–≤ —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
     * –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (CFA, FRM, ACCA –∏ —Ç.–¥.) —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –≤–∞–∂–Ω–æ—Å—Ç–∏
     * –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
   
   - –í–ê–ö–ê–ù–°–ò–ò –ù–ê –ü–£–¢–ò –ö –¶–ï–õ–ò (—Ç–æ–ø-5 –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π):
     * –ö–∞–∫–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø—É—Ç–∏ –∫ —Ü–µ–ª–∏
     * –ü–æ—á–µ–º—É –∫–∞–∂–¥–∞—è –≤–∞–∫–∞–Ω—Å–∏—è –≤–∞–∂–Ω–∞
     * –ö–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –ø–æ–∑–∏—Ü–∏—é
   
   - –ü–†–û–ï–ö–¢–´ –ò –ó–ê–î–ê–ß–ò –î–õ–Ø –û–ü–´–¢–ê (—Ç–æ–ø-7):
     * –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
     * –ó–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –≤–∑—è—Ç—å –Ω–∞ —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç–µ
     * Side-–ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –Ω–∞–≤—ã–∫–æ–≤

6. –í–†–ï–ú–ï–ù–ù–ê–Ø –î–û–†–û–ñ–ù–ê–Ø –ö–ê–†–¢–ê:
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞ (–¥–µ—Ç–∞–ª—å–Ω–æ)
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ 3-6 –º–µ—Å—è—Ü–µ–≤ (–¥–µ—Ç–∞–ª—å–Ω–æ)
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ 6-12 –º–µ—Å—è—Ü–µ–≤ (–¥–µ—Ç–∞–ª—å–Ω–æ)
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ 1-3 –≥–æ–¥–∞ (–¥–µ—Ç–∞–ª—å–Ω–æ)
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ 3-5 –ª–µ—Ç (–¥–µ—Ç–∞–ª—å–Ω–æ)

–í–ê–ñ–ù–û: 
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ú, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –º–µ—Ç—Ä–∏–∫–∏
- –ù–ï –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –æ—Ç–≤–µ—Ç –ø—Ä–æ—Å—Ç–æ "—Å–ø–∞—Å–∏–±–æ" - –¥–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5-7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å`;
                
                const r = await retry(`${API}/chat/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: analysisPrompt })
                }, 3);
                
                untype();
                hideProgress();
                
                if (!r.ok) throw new Error(`Analysis failed: ${r.status}`);
                
                const d = await r.json();
                const analysisResult = d.reply || '';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—Ä–∞—Å–∏–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                let html = `<div class="profile-card">`;
                html += `<div class="profile-section-title">üéØ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö —Ü–µ–ª–µ–π</div>`;
                html += `<div class="profile-section">`;
                html += `<div class="profile-item" style="white-space: pre-wrap; line-height: 1.8;">${analysisResult.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
                html += `</div></div>`;
                
                addHTML('assistant', html);
                actions();
            } catch (e) {
                untype();
                hideProgress();
                add('system', "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏");
                actions();
            }
        }
        
        async function createCareerPlanFromGoals(userGoals) {
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–π
            untype();
            hideProgress();
            typing();
            showProgress();
            
            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–ª–∏
                let targetPosition = "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä";
                let targetField = "–§–∏–Ω–∞–Ω—Å—ã";
                const text = userGoals.toLowerCase();
                
                if (text.includes('cfo') || text.includes('—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä')) {
                    targetPosition = "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä (CFO)";
                } else if (text.includes('–¥–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º') || text.includes('–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä')) {
                    targetPosition = "–î–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º";
                    targetField = "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏";
                } else if (text.includes('—Ä–∏—Å–∫')) {
                    targetPosition = "–î–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É";
                    targetField = "–†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç";
                } else if (text.includes('–¥–∏—Ä–µ–∫—Ç–æ—Ä')) {
                    targetPosition = userGoals.split('\n')[0].trim() || "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä";
                }
                
                if (text.includes('–±–∞–Ω–∫')) targetField = "–ë–∞–Ω–∫–∏";
                else if (text.includes('–∏–Ω–≤–µ—Å—Ç')) targetField = "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏";
                else if (text.includes('—Ñ–∏–Ω—Ç–µ—Ö') || text.includes('fintech')) targetField = "–§–∏–Ω—Ç–µ—Ö";
                
                const planR = await retry(`${API}/match/career-development`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        target_position: targetPosition,
                        target_field: targetField
                    })
                }, 3);
                
                untype();
                hideProgress();
                
                if (!planR.ok) {
                    add('system', "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω.");
                    actions();
                    return;
                }
                
                const planData = await planR.json();
                const courses = planData.courses || [];
                const vacancies = planData.future_vacancies || [];
                const gapAnalysis = planData.gap_analysis || "";
                
                let html = `<div class="profile-card">`;
                html += `<div class="profile-section-title">üöÄ –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã –∫ –ø–æ–∑–∏—Ü–∏–∏: ${targetPosition}</div>`;
                
                if (gapAnalysis) {
                    html += `<div class="profile-section"><div class="profile-section-title">üìä –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑—Ä—ã–≤–∞ –≤ –Ω–∞–≤—ã–∫–∞—Ö</div>`;
                    html += `<div class="profile-item">${gapAnalysis}</div></div>`;
                }
                
                if (courses.length > 0) {
                    html += `<div class="profile-section"><div class="profile-section-title">üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫—É—Ä—Å—ã (${courses.length})</div>`;
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∫—É—Ä—Å—ã —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ URL –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
                    const validCourses = courses.filter(course => {
                        if (!course.url || !course.url.trim()) return false;
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –Ω–µ –ø—É—Å—Ç–æ–π –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–æ–∫
                        try {
                            const url = new URL(course.url);
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π HTTP/HTTPS URL —Å –¥–æ–º–µ–Ω–æ–º
                            if (url.protocol !== 'http:' && url.protocol !== 'https:') return false;
                            if (!url.hostname || url.hostname.length < 3) return false;
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            if (url.pathname === '/' && !url.search) {
                                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–æ–º–µ–Ω –±–µ–∑ –ø—É—Ç–∏, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
                                return true;
                            }
                            return true;
                        } catch {
                            return false;
                        }
                    });
                    
                    if (validCourses.length === 0) {
                        html += `<div class="profile-item" style="color: var(--text-dim); font-style: italic;">–ö—É—Ä—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</div>`;
                    } else {
                        validCourses.slice(0, 7).forEach((course, idx) => {
                        html += `<div class="course-card">`;
                        html += `<div class="course-title">${idx + 1}. ${course.name || '–ö—É—Ä—Å'}</div>`;
                        if (course.provider) html += `<div class="course-info">üè´ ${course.provider}</div>`;
                        if (course.skills) html += `<div class="course-info">üõ†Ô∏è ${course.skills}</div>`;
                        if (course.level) html += `<div class="course-info">üìä –£—Ä–æ–≤–µ–Ω—å: ${course.level}</div>`;
                        if (course.url) html += `<a href="${course.url}" target="_blank" rel="noopener" class="course-link">üìñ –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫—É—Ä—Å—É</a>`;
                        html += `</div>`;
                    });
                    }
                    html += `</div>`;
                }
                
                if (vacancies.length > 0) {
                    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –≤–∞–∫–∞–Ω—Å–∏–∏ (1-5)
                    function getVacancyLevel(vac) {
                        const title = (vac.title || '').toLowerCase();
                        const exp = (vac.experience || '').toLowerCase();
                        
                        if (title.includes('—Å—Ç–∞–∂–µ—Ä') || title.includes('intern') || exp.includes('–±–µ–∑ –æ–ø—ã—Ç–∞')) {
                            return { level: 1, label: '–ù–∞—á–∞–ª—å–Ω—ã–π', color: '#22c55e' };
                        }
                        if (title.includes('junior') || title.includes('–º–ª–∞–¥—à–∏–π') || exp.includes('–¥–æ 1 –≥–æ–¥–∞')) {
                            return { level: 2, label: '–ú–ª–∞–¥—à–∏–π', color: '#10a37f' };
                        }
                        if (title.includes('middle') || title.includes('—Å—Ä–µ–¥–Ω–∏–π') || exp.includes('1-3 –≥–æ–¥–∞')) {
                            return { level: 3, label: '–°—Ä–µ–¥–Ω–∏–π', color: '#fbbf24' };
                        }
                        if (title.includes('senior') || title.includes('lead') || exp.includes('3-6 –ª–µ—Ç')) {
                            return { level: 4, label: '–°—Ç–∞—Ä—à–∏–π', color: '#f97316' };
                        }
                        if (title.includes('director') || title.includes('–¥–∏—Ä–µ–∫—Ç–æ—Ä') || exp.includes('–±–æ–ª–µ–µ 6 –ª–µ—Ç')) {
                            return { level: 5, label: '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π', color: '#ef4444' };
                        }
                        return { level: 3, label: '–°—Ä–µ–¥–Ω–∏–π', color: '#fbbf24' };
                    }
                    
                    html += `<div class="profile-section"><div class="profile-section-title">üíº –í–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞ –ø—É—Ç–∏ –∫ —Ü–µ–ª–∏ (${vacancies.length})</div>`;
                    vacancies.slice(0, 15).forEach((vac, idx) => {
                        const levelInfo = getVacancyLevel(vac);
                        const descPreview = vac.description ? 
                            (vac.description.length > 200 ? vac.description.substring(0, 200) + '...' : vac.description) : '';
                        
                        html += `<div class="vacancy-card">`;
                        html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">`;
                        html += `<div class="vacancy-title" style="flex: 1;">${idx + 1}. ${vac.title || '–í–∞–∫–∞–Ω—Å–∏—è'}</div>`;
                        html += `<span class="vacancy-level-badge" style="background: ${levelInfo.color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; margin-left: 12px;">${levelInfo.level}/5 ${levelInfo.label}</span>`;
                        html += `</div>`;
                        if (vac.company) html += `<div class="vacancy-info">üè¢ ${vac.company}</div>`;
                        if (vac.location) html += `<div class="vacancy-info">üìç ${vac.location}</div>`;
                        if (vac.salary) html += `<div class="vacancy-info">üí∞ ${vac.salary}</div>`;
                        if (vac.experience) html += `<div class="vacancy-info">‚è≥ ${vac.experience}</div>`;
                        if (descPreview) {
                            html += `<div class="vacancy-description" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 13px; color: var(--text-dim); line-height: 1.5;">${descPreview}</div>`;
                        }
                        if (vac.key_skills) {
                            const skills = vac.key_skills.split(',').slice(0, 5).join(', ');
                            html += `<div class="vacancy-info" style="margin-top: 8px;"><strong>–ù–∞–≤—ã–∫–∏:</strong> ${skills}</div>`;
                        }
                        if (vac.hh_url) html += `<a href="${vac.hh_url}" target="_blank" rel="noopener" class="vacancy-link">üîó –û—Ç–∫—Ä—ã—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</a>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                }
                
                html += `</div>`;
                
                addHTML('assistant', html, false);
                // –°–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–∞—á–∞–ª—É –ø–ª–∞–Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏—è
                setTimeout(() => {
                    const chat = document.getElementById('chat');
                    const planCard = chat?.querySelector('.profile-card');
                    if (planCard) {
                        const rect = planCard.getBoundingClientRect();
                        const chatRect = chat.getBoundingClientRect();
                        const scrollTop = chat.scrollTop + rect.top - chatRect.top - 20;
                        chat.scrollTo({ top: scrollTop, behavior: 'smooth' });
                    }
                    actions();
                }, 300);
            } catch (e) {
                untype();
                hideProgress();
                add('system', "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è");
                actions();
            }
        }

        function add(role, txt, scr=true) {
            const c = document.getElementById('chat');
            if (!c) return;
            
            const m = document.createElement('div');
            m.className = `msg ${role === 'assistant' ? 'ai' : ''}`;
            const av = role === 'user' ? 'üë§' : (role === 'system' ? '‚ö†Ô∏è' : 'üíπ');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π markdown —Å—Å—ã–ª–æ–∫ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            let formatted = txt
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                .replace(/\n/g, '<br>');
            
            m.innerHTML = `<div class="avatar ${role}">${av}</div><div class="msg-content">${formatted}</div>`;
            c.appendChild(m);
            if (scr) scrollToBottom();
        }
        
        function addHTML(role, html, scr=true) {
            const c = document.getElementById('chat');
            if (!c) return;
            
            const m = document.createElement('div');
            m.className = `msg ${role === 'assistant' ? 'ai' : ''}`;
            const av = role === 'user' ? 'üë§' : (role === 'system' ? '‚ö†Ô∏è' : 'üíπ');
            
            m.innerHTML = `<div class="avatar ${role}">${av}</div><div class="msg-content">${html}</div>`;
            c.appendChild(m);
            if (scr) scrollToBottom();
        }

        function typing() {
            const c = document.getElementById('chat');
            if (!c) return;
            
            const d = document.createElement('div');
            d.id = 't';
            d.className = 'msg ai';
            d.innerHTML = '<div class="avatar ai">üíπ</div><div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            c.appendChild(d);
            scrollToBottom();
        }
        function untype() { 
            const e = document.getElementById('t'); 
            if (e) e.remove(); 
        }

        function actions() {
            const c = document.getElementById('chat');
            if (!c || c.querySelector('.action-buttons')) return;
            
            const d = document.createElement('div');
            d.className = 'msg ai';
            d.innerHTML = `<div class="avatar ai">üíπ</div><div class="msg-content"><strong>–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?</strong><div class="action-buttons"><button class="btn" onclick="handleProfileAction()">üìã –ü—Ä–æ—Ñ–∏–ª—å</button><button class="btn" onclick="handleVacanciesAction()">üîç –í–∞–∫–∞–Ω—Å–∏–∏</button><button class="btn" onclick="handleCareerPlanAction()">üöÄ –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è</button></div></div>`;
            c.appendChild(d);
            scrollToBottom();
        }

        // Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            setTimeout(init, 100);
        }
    </script>
    <footer style="position: fixed; bottom: 20px; left: 20px; color: var(--primary-light); font-size: 14px; font-weight: 500; z-index: 1000; opacity: 0.9; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.3); letter-spacing: 0.3px;">
        <span style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">‚ú¶</span> Made by Anton Orlov
    </footer>
</body>
</html>
